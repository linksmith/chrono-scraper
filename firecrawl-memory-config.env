# Memory-optimized Firecrawl configuration for Hetzner CX32 (8GB RAM)
# This configuration prioritizes memory efficiency for browser automation
# while maintaining functionality for web scraping operations

# =============================================================================
# BROWSER MEMORY OPTIMIZATION
# =============================================================================

# Core browser settings - aggressive memory management
FIRECRAWL_BLOCK_MEDIA=true
FIRECRAWL_DISABLE_JAVASCRIPT=false
FIRECRAWL_DISABLE_IMAGES=true
FIRECRAWL_DISABLE_CSS=false

# Browser pool configuration - minimize concurrent sessions
MAX_CONCURRENT_SESSIONS=1
BROWSER_POOL_SIZE=1
BROWSER_INSTANCE_TIMEOUT=60000
BROWSER_IDLE_TIMEOUT=30000

# Chrome/Chromium flags for memory optimization
CHROME_FLAGS="--memory-pressure-off --max_old_space_size=1400 --disable-dev-shm-usage --disable-gpu --no-sandbox --disable-setuid-sandbox --disable-background-timer-throttling --disable-backgrounding-occluded-windows --disable-renderer-backgrounding --disable-features=TranslateUI --disable-ipc-flooding-protection --disable-extensions --disable-plugins --disable-background-networking --disable-default-apps --disable-sync --disable-translate --hide-scrollbars --mute-audio --no-first-run --no-default-browser-check --disable-infobars --disable-notifications --disable-permissions-api"

# Node.js memory limits for Playwright service
NODE_OPTIONS="--max-old-space-size=1400 --max-semi-space-size=128"

# V8 garbage collection optimization
NODE_GC_FLAGS="--expose-gc --optimize-for-size --max-semi-space-size=128"

# =============================================================================
# PLAYWRIGHT SERVICE CONFIGURATION
# =============================================================================

# Browser path and cache settings
PLAYWRIGHT_BROWSERS_PATH=/tmp/.cache
PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=false
PLAYWRIGHT_SKIP_VALIDATE_HOST_REQUIREMENTS=true

# Timeout configurations - shorter for memory pressure
DEFAULT_TIMEOUT=90000
MAX_TIMEOUT=90000
NAVIGATION_TIMEOUT=60000
ACTION_TIMEOUT=30000

# Resource management
PLAYWRIGHT_HEADLESS=true
PLAYWRIGHT_SLOW_MO=0
PLAYWRIGHT_VIDEO=false
PLAYWRIGHT_TRACE=false

# Browser context settings for memory efficiency
BROWSER_CONTEXT_OPTIONS='{"ignoreHTTPSErrors":true,"bypassCSP":true,"viewport":{"width":1280,"height":720},"userAgent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"}'

# =============================================================================
# FIRECRAWL API CONFIGURATION
# =============================================================================

# Worker concurrency - reduced for memory constraints
WORKER_CONCURRENCY=2
NUM_WORKERS_PER_QUEUE=4
BULL_MAX_WORKERS=2

# Queue settings optimized for limited memory
BULL_REDIS_DB=0
BULL_MAX_JOBS_PER_WORKER=5
BULL_DEFAULT_JOB_OPTIONS='{"removeOnComplete":5,"removeOnFail":10,"attempts":2,"backoff":{"type":"exponential","delay":2000}}'

# Memory-aware processing limits
MAX_PAGES_PER_CRAWL=50
MAX_CONCURRENT_CRAWLS=1
MAX_DEPTH=3
MAX_FILE_SIZE=10485760  # 10MB

# Content processing optimization
ENABLE_CONTENT_EXTRACTION=true
ENABLE_MARKDOWN_GENERATION=true
ENABLE_SCREENSHOT=false  # Disabled to save memory
ENABLE_PDF_GENERATION=false  # Disabled to save memory

# =============================================================================
# MEMORY MONITORING & LIMITS
# =============================================================================

# Process memory limits (in MB)
FIRECRAWL_API_MEMORY_LIMIT=600
FIRECRAWL_WORKER_MEMORY_LIMIT=800
FIRECRAWL_PLAYWRIGHT_MEMORY_LIMIT=1800

# Memory warning thresholds
MEMORY_WARNING_THRESHOLD=85  # % of allocated memory
MEMORY_CRITICAL_THRESHOLD=95 # % of allocated memory

# Garbage collection settings
GC_AGGRESSIVE=true
GC_INTERVAL=30000  # Run GC every 30 seconds
FORCE_GC_ON_HIGH_MEMORY=true

# Process restart settings for memory leaks
MAX_MEMORY_USAGE_RESTART=1600  # Restart if memory exceeds 1.6GB
MEMORY_CHECK_INTERVAL=60000    # Check memory usage every minute
AUTO_RESTART_ON_MEMORY_LEAK=true

# =============================================================================
# PROXY & NETWORK OPTIMIZATION
# =============================================================================

# Network settings for memory efficiency
HTTP_TIMEOUT=30000
HTTP_MAX_REDIRECTS=5
HTTP_KEEP_ALIVE=false
HTTP_MAX_SOCKETS=20

# Proxy settings (if needed)
FIRECRAWL_PROXY_SERVER=${FIRECRAWL_PROXY_SERVER:-}
FIRECRAWL_PROXY_USERNAME=${FIRECRAWL_PROXY_USERNAME:-}
FIRECRAWL_PROXY_PASSWORD=${FIRECRAWL_PROXY_PASSWORD:-}

# Rate limiting for memory management
RATE_LIMIT_REQUESTS_PER_MINUTE=60
RATE_LIMIT_BURST=10

# =============================================================================
# CACHING CONFIGURATION
# =============================================================================

# Redis cache settings optimized for memory
REDIS_CACHE_TTL=3600  # 1 hour cache
REDIS_MAX_MEMORY_POLICY=allkeys-lru
REDIS_CACHE_PREFIX=firecrawl:cache:

# Enable caching for frequently accessed content
ENABLE_CONTENT_CACHE=true
ENABLE_ROBOTS_CACHE=true
ENABLE_SITEMAP_CACHE=true

# Cache size limits
MAX_CACHE_ENTRIES=1000
CACHE_CLEANUP_INTERVAL=300000  # 5 minutes

# =============================================================================
# LOGGING & MONITORING
# =============================================================================

# Logging configuration - reduced for memory savings
FIRECRAWL_LOGGING_LEVEL=warn
LOG_MAX_FILES=5
LOG_MAX_SIZE=10485760  # 10MB per log file
ENABLE_REQUEST_LOGGING=false
ENABLE_PERFORMANCE_LOGGING=true

# Metrics collection
ENABLE_METRICS=true
METRICS_PORT=9090
METRICS_PATH=/metrics

# Health check configuration
HEALTH_CHECK_INTERVAL=30000
HEALTH_CHECK_TIMEOUT=5000
HEALTH_CHECK_RETRIES=3

# =============================================================================
# ERROR HANDLING & RECOVERY
# =============================================================================

# Error handling for memory pressure
MAX_RETRY_ATTEMPTS=2
RETRY_DELAY=5000
EXPONENTIAL_BACKOFF=true

# Circuit breaker settings
CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
CIRCUIT_BREAKER_RECOVERY_TIMEOUT=60000
CIRCUIT_BREAKER_MONITOR_INTERVAL=30000

# Graceful shutdown settings
SHUTDOWN_TIMEOUT=30000
GRACEFUL_SHUTDOWN_ENABLED=true

# OOM (Out of Memory) handling
ENABLE_OOM_KILLER_PROTECTION=true
OOM_SCORE_ADJ=-500

# =============================================================================
# WAYBACK MACHINE SPECIFIC OPTIMIZATIONS
# =============================================================================

# Extended timeouts for Wayback Machine (they can be slow)
WAYBACK_TIMEOUT=120000
WAYBACK_MAX_RETRIES=2
WAYBACK_RETRY_DELAY=10000

# Wayback-specific browser settings
WAYBACK_DISABLE_IMAGES=true
WAYBACK_DISABLE_CSS=false
WAYBACK_WAIT_FOR_SELECTOR_TIMEOUT=10000

# Content filtering for Wayback pages
WAYBACK_REMOVE_SCRIPTS=true
WAYBACK_REMOVE_STYLESHEETS=false
WAYBACK_CLEAN_HTML=true

# =============================================================================
# PRODUCTION OPTIMIZATION FLAGS
# =============================================================================

# Environment settings
NODE_ENV=production
ENVIRONMENT=production

# Security settings
DISABLE_TELEMETRY=true
DISABLE_UPDATE_NOTIFIER=true
DISABLE_ANALYTICS=true

# Performance flags
FORCE_COLOR=0
NO_PROGRESS_BAR=true
SILENT_MODE=false

# Process optimization
UV_THREADPOOL_SIZE=8
LIBUV_THREADPOOL_SIZE=8

# =============================================================================
# CONTAINER-SPECIFIC SETTINGS
# =============================================================================

# Docker container memory settings
CONTAINER_MEMORY_LIMIT=1800M
CONTAINER_CPU_LIMIT=1.5
CONTAINER_SWAP_LIMIT=0

# Shared memory settings
SHM_SIZE=1gb

# File system optimization
TMPFS_SIZE=512M
TMPFS_OPTIONS=noatime,size=512M

# =============================================================================
# MONITORING INTEGRATION
# =============================================================================

# Prometheus metrics
ENABLE_PROMETHEUS_METRICS=true
PROMETHEUS_PORT=9090
PROMETHEUS_NAMESPACE=firecrawl

# Custom metrics
TRACK_MEMORY_USAGE=true
TRACK_REQUEST_DURATION=true
TRACK_QUEUE_SIZE=true
TRACK_BROWSER_SESSIONS=true

# Alert thresholds for monitoring
ALERT_HIGH_MEMORY_THRESHOLD=1400  # MB
ALERT_HIGH_CPU_THRESHOLD=90       # %
ALERT_QUEUE_SIZE_THRESHOLD=100    # jobs
ALERT_RESPONSE_TIME_THRESHOLD=30000  # ms

# =============================================================================
# DEVELOPMENT vs PRODUCTION OVERRIDES
# =============================================================================

# These settings are overridden in development
# In production, ensure these are set appropriately:
# - FIRECRAWL_LOGGING_LEVEL=error
# - ENABLE_REQUEST_LOGGING=false
# - ENABLE_CONTENT_CACHE=true
# - MAX_CONCURRENT_SESSIONS=1
# - BROWSER_POOL_SIZE=1