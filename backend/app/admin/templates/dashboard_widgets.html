<!-- Dashboard Widget Components -->
<script>
// Dashboard Widget Classes for Reusable Components
class DashboardWidget {
    constructor(containerId, options = {}) {
        this.container = document.getElementById(containerId);
        this.options = options;
        this.data = null;
        this.chart = null;
        this.refreshInterval = null;
        this.init();
    }
    
    init() {
        this.render();
        if (this.options.autoRefresh) {
            this.startAutoRefresh();
        }
    }
    
    render() {
        // Override in subclasses
    }
    
    updateData(newData) {
        this.data = newData;
        this.render();
    }
    
    startAutoRefresh() {
        if (this.options.refreshInterval) {
            this.refreshInterval = setInterval(() => {
                this.refresh();
            }, this.options.refreshInterval);
        }
    }
    
    stopAutoRefresh() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
            this.refreshInterval = null;
        }
    }
    
    async refresh() {
        // Override in subclasses
    }
    
    destroy() {
        this.stopAutoRefresh();
        if (this.chart) {
            this.chart.destroy();
        }
        this.container.innerHTML = '';
    }
}

// Metric Card Widget
class MetricCardWidget extends DashboardWidget {
    render() {
        if (!this.data) return;
        
        const { title, value, change, icon, color = 'blue' } = this.data;
        const changeClass = change >= 0 ? 'text-green-600' : 'text-red-600';
        const changeIcon = change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
        
        this.container.innerHTML = `
            <div class="metric-card bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-${color}-500 rounded-md flex items-center justify-center">
                                <i class="${icon} text-white text-sm"></i>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">${title}</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900">${value}</div>
                                    <div class="ml-2 flex items-baseline text-sm font-semibold ${changeClass}">
                                        <i class="fas ${changeIcon} text-xs mr-1"></i>
                                        <span>${Math.abs(change)}%</span>
                                    </div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
}

// Time Series Chart Widget
class TimeSeriesChartWidget extends DashboardWidget {
    render() {
        if (!this.data || !this.data.datasets) return;
        
        const canvasId = `chart-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        this.container.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">${this.data.title || 'Chart'}</h3>
                    <div class="flex items-center space-x-4">
                        ${this.data.legends ? this.data.legends.map(legend => `
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-${legend.color} rounded-full"></div>
                                <span class="text-sm text-gray-600">${legend.label}</span>
                            </div>
                        `).join('') : ''}
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="${canvasId}"></canvas>
                </div>
            </div>
        `;
        
        setTimeout(() => {
            const ctx = document.getElementById(canvasId);
            if (ctx && window.Chart) {
                if (this.chart) {
                    this.chart.destroy();
                }
                
                this.chart = new Chart(ctx, {
                    type: this.data.type || 'line',
                    data: {
                        labels: this.data.labels,
                        datasets: this.data.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        },
                        ...this.options.chartOptions
                    }
                });
            }
        }, 100);
    }
}

// Status List Widget
class StatusListWidget extends DashboardWidget {
    render() {
        if (!this.data || !this.data.items) return;
        
        const items = this.data.items.map(item => {
            const statusClass = this.getStatusClass(item.status);
            return `
                <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
                    <div class="flex items-center">
                        <span class="status-indicator ${statusClass}"></span>
                        <span class="text-sm font-medium text-gray-900">${item.name}</span>
                    </div>
                    <div class="text-xs text-gray-500">${item.status}</div>
                    ${item.metric ? `<div class="text-sm text-gray-600">${item.metric}</div>` : ''}
                </div>
            `;
        }).join('');
        
        this.container.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-medium text-gray-900 mb-4">${this.data.title}</h3>
                <div class="space-y-3">
                    ${items}
                </div>
            </div>
        `;
    }
    
    getStatusClass(status) {
        switch (status) {
            case 'healthy': case 'operational': case 'success': return 'status-healthy';
            case 'warning': case 'degraded': case 'caution': return 'status-warning';
            case 'critical': case 'unhealthy': case 'error': return 'status-critical';
            default: return 'status-unknown';
        }
    }
}

// Activity Feed Widget
class ActivityFeedWidget extends DashboardWidget {
    render() {
        if (!this.data || !this.data.items) return;
        
        const items = this.data.items.map(item => {
            const statusClass = item.success ? 'bg-green-400' : 'bg-red-400';
            const timestamp = new Date(item.timestamp).toLocaleString();
            
            return `
                <div class="flex items-center text-sm">
                    <div class="w-2 h-2 rounded-full mr-3 ${statusClass}"></div>
                    <div class="flex-1 min-w-0">
                        <p class="text-gray-900 truncate">${item.action}</p>
                        <p class="text-gray-500 text-xs">${timestamp}</p>
                        ${item.details ? `<p class="text-gray-400 text-xs">${item.details}</p>` : ''}
                    </div>
                </div>
            `;
        }).join('');
        
        this.container.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-medium text-gray-900 mb-4">${this.data.title}</h3>
                <div class="space-y-3 max-h-64 overflow-y-auto">
                    ${items}
                </div>
            </div>
        `;
    }
}

// Progress Bar Widget
class ProgressBarWidget extends DashboardWidget {
    render() {
        if (!this.data) return;
        
        const { title, progress, total, color = 'blue', showNumbers = true } = this.data;
        const percentage = total > 0 ? Math.round((progress / total) * 100) : 0;
        
        this.container.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-medium text-gray-900">${title}</h3>
                    ${showNumbers ? `<span class="text-sm text-gray-500">${progress}/${total}</span>` : ''}
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-${color}-600 h-2.5 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
                </div>
                <div class="mt-2 text-right">
                    <span class="text-sm font-medium text-gray-600">${percentage}%</span>
                </div>
            </div>
        `;
    }
}

// Alert Panel Widget
class AlertPanelWidget extends DashboardWidget {
    render() {
        if (!this.data || !this.data.alerts || this.data.alerts.length === 0) {
            this.container.innerHTML = '';
            return;
        }
        
        const alerts = this.data.alerts.map(alert => {
            const severityClass = this.getSeverityClass(alert.severity);
            const timestamp = new Date(alert.timestamp).toLocaleString();
            
            return `
                <li class="flex justify-between items-center">
                    <span>
                        <strong class="${severityClass}">${alert.severity.toUpperCase()}</strong>: 
                        <span>${alert.message}</span>
                        <small class="text-gray-500 ml-2">${timestamp}</small>
                    </span>
                    <button onclick="acknowledgeAlert('${alert.id}')" class="ml-4 text-red-600 hover:text-red-800">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </li>
            `;
        }).join('');
        
        this.container.innerHTML = `
            <div class="mb-8 bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-400"></i>
                    </div>
                    <div class="ml-3 flex-1">
                        <h3 class="text-sm font-medium text-red-800">Active Alerts (${this.data.alerts.length})</h3>
                        <div class="mt-2 text-sm text-red-700">
                            <ul class="list-disc pl-5 space-y-1">
                                ${alerts}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    getSeverityClass(severity) {
        switch (severity.toLowerCase()) {
            case 'critical': return 'text-red-700';
            case 'high': return 'text-red-600';
            case 'medium': return 'text-yellow-600';
            case 'low': return 'text-blue-600';
            default: return 'text-gray-600';
        }
    }
}

// Top Items Widget (for domains, projects, etc.)
class TopItemsWidget extends DashboardWidget {
    render() {
        if (!this.data || !this.data.items) return;
        
        const items = this.data.items.map(item => `
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-900 truncate" title="${item.name}">${item.name}</div>
                <div class="text-sm text-gray-500">${item.value} ${this.data.unit || ''}</div>
            </div>
        `).join('');
        
        this.container.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-medium text-gray-900 mb-4">${this.data.title}</h3>
                <div class="space-y-3">
                    ${items}
                </div>
                ${this.data.showMore ? `
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <a href="${this.data.moreLink}" class="text-sm text-blue-600 hover:text-blue-800">
                            View all ${this.data.totalCount || ''}
                        </a>
                    </div>
                ` : ''}
            </div>
        `;
    }
}

// Donut Chart Widget
class DonutChartWidget extends DashboardWidget {
    render() {
        if (!this.data || !this.data.segments) return;
        
        const canvasId = `donut-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        this.container.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-medium text-gray-900 mb-4">${this.data.title}</h3>
                <div class="chart-container">
                    <canvas id="${canvasId}"></canvas>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-2">
                    ${this.data.segments.map(segment => `
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${segment.color}"></div>
                            <span class="text-sm text-gray-600">${segment.label}: ${segment.value}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        setTimeout(() => {
            const ctx = document.getElementById(canvasId);
            if (ctx && window.Chart) {
                if (this.chart) {
                    this.chart.destroy();
                }
                
                this.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: this.data.segments.map(s => s.label),
                        datasets: [{
                            data: this.data.segments.map(s => s.value),
                            backgroundColor: this.data.segments.map(s => s.color),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }, 100);
    }
}

// Widget Factory
class DashboardWidgetFactory {
    static createWidget(type, containerId, data, options = {}) {
        switch (type) {
            case 'metric-card':
                return new MetricCardWidget(containerId, options);
            case 'time-series':
                return new TimeSeriesChartWidget(containerId, options);
            case 'status-list':
                return new StatusListWidget(containerId, options);
            case 'activity-feed':
                return new ActivityFeedWidget(containerId, options);
            case 'progress-bar':
                return new ProgressBarWidget(containerId, options);
            case 'alert-panel':
                return new AlertPanelWidget(containerId, options);
            case 'top-items':
                return new TopItemsWidget(containerId, options);
            case 'donut-chart':
                return new DonutChartWidget(containerId, options);
            default:
                return new DashboardWidget(containerId, options);
        }
    }
}

// Global widget manager
window.DashboardWidgets = {
    Widget: DashboardWidget,
    MetricCardWidget: MetricCardWidget,
    TimeSeriesChartWidget: TimeSeriesChartWidget,
    StatusListWidget: StatusListWidget,
    ActivityFeedWidget: ActivityFeedWidget,
    ProgressBarWidget: ProgressBarWidget,
    AlertPanelWidget: AlertPanelWidget,
    TopItemsWidget: TopItemsWidget,
    DonutChartWidget: DonutChartWidget,
    Factory: DashboardWidgetFactory
};

// Global utility functions
window.acknowledgeAlert = async function(alertId) {
    try {
        const response = await fetch('/admin/dashboard/alerts/acknowledge', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ alert_id: alertId })
        });
        
        if (response.ok) {
            // Remove alert from UI
            const alertElement = document.querySelector(`[onclick="acknowledgeAlert('${alertId}')"]`).closest('li');
            if (alertElement) {
                alertElement.remove();
            }
            
            // Check if no more alerts
            const alertsList = document.querySelector('.bg-red-50 ul');
            if (alertsList && alertsList.children.length === 0) {
                document.querySelector('.bg-red-50').remove();
            }
        }
    } catch (error) {
        console.error('Error acknowledging alert:', error);
    }
};

// Auto-refresh manager
window.DashboardAutoRefresh = {
    intervals: new Map(),
    
    start(widgetId, callback, intervalMs = 30000) {
        this.stop(widgetId);
        const intervalId = setInterval(callback, intervalMs);
        this.intervals.set(widgetId, intervalId);
    },
    
    stop(widgetId) {
        const intervalId = this.intervals.get(widgetId);
        if (intervalId) {
            clearInterval(intervalId);
            this.intervals.delete(widgetId);
        }
    },
    
    stopAll() {
        this.intervals.forEach((intervalId) => {
            clearInterval(intervalId);
        });
        this.intervals.clear();
    }
};

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    window.DashboardAutoRefresh.stopAll();
});
</script>

<style>
/* Widget Styles */
.widget-container {
    @apply p-4;
}

.metric-card {
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px -8px rgba(0, 0, 0, 0.1);
}

.chart-container {
    position: relative;
    height: 300px;
}

.chart-container canvas {
    max-height: 100%;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.status-healthy {
    background-color: #10b981;
}

.status-warning {
    background-color: #f59e0b;
}

.status-critical {
    background-color: #ef4444;
}

.status-unknown {
    background-color: #6b7280;
}

/* Responsive chart adjustments */
@media (max-width: 768px) {
    .chart-container {
        height: 250px;
    }
}

@media (max-width: 640px) {
    .chart-container {
        height: 200px;
    }
}

/* Loading states */
.widget-loading {
    @apply animate-pulse;
}

.widget-loading .widget-content {
    @apply bg-gray-200 rounded;
}

/* Animation for metric changes */
.metric-change-animation {
    animation: metricPulse 0.6s ease-in-out;
}

@keyframes metricPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Alert animations */
.alert-slide-in {
    animation: slideInFromTop 0.3s ease-out;
}

@keyframes slideInFromTop {
    0% {
        transform: translateY(-100%);
        opacity: 0;
    }
    100% {
        transform: translateY(0);
        opacity: 1;
    }
}

.alert-slide-out {
    animation: slideOutToTop 0.3s ease-in;
}

@keyframes slideOutToTop {
    0% {
        transform: translateY(0);
        opacity: 1;
    }
    100% {
        transform: translateY(-100%);
        opacity: 0;
    }
}

/* Hover effects for interactive elements */
.widget-interactive:hover {
    @apply shadow-lg;
    transform: translateY(-1px);
}

/* Progress bar animations */
.progress-bar-fill {
    transition: width 1s ease-in-out;
}

/* Grid auto-fit for responsive widget layouts */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

@media (max-width: 768px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
}

/* Custom scrollbar for activity feeds */
.activity-feed::-webkit-scrollbar {
    width: 4px;
}

.activity-feed::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}

.activity-feed::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 2px;
}

.activity-feed::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
}
</style>