<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - Chrono Scraper Admin</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom styles -->
    <style>
        .status-healthy { @apply bg-green-100 text-green-800 border-green-200; }
        .status-degraded { @apply bg-yellow-100 text-yellow-800 border-yellow-200; }
        .status-unhealthy { @apply bg-orange-100 text-orange-800 border-orange-200; }
        .status-critical { @apply bg-red-100 text-red-800 border-red-200; }
        .metric-card { @apply bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow; }
        .pulse-dot { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .refresh-spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                        System Monitoring Dashboard
                    </h1>
                    <div class="flex items-center space-x-2">
                        <div class="status-indicator status-{{ dashboard_data.overall_status }} px-3 py-1 rounded-full text-sm font-medium border">
                            <i class="fas fa-circle pulse-dot mr-1"></i>
                            {{ dashboard_data.overall_status|title }}
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="text-sm text-gray-500">Last updated: <span id="last-updated">{{ dashboard_data.timestamp }}</span></span>
                    <button id="refresh-btn" class="btn btn-primary">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Refresh
                    </button>
                    <button id="auto-refresh-toggle" class="btn btn-secondary">
                        <i class="fas fa-play mr-2"></i>
                        Auto Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Alert Banner -->
        {% if dashboard_data.alert_counts.critical > 0 %}
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
                <div>
                    <h3 class="text-lg font-semibold text-red-800">Critical Issues Detected</h3>
                    <p class="text-red-700">{{ dashboard_data.alert_counts.critical }} critical issues and {{ dashboard_data.alert_counts.warnings }} warnings require attention.</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- System Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Overall System Health -->
            <div class="metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">System Health</p>
                        <p class="text-2xl font-bold text-gray-900">{{ dashboard_data.overall_status|title }}</p>
                    </div>
                    <div class="h-12 w-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-server text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Active Workers -->
            <div class="metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Celery Workers</p>
                        <p class="text-2xl font-bold text-gray-900">{{ dashboard_data.celery_metrics.workers.count or 0 }}</p>
                    </div>
                    <div class="h-12 w-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-cogs text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Queue Length -->
            <div class="metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Queue Tasks</p>
                        <p class="text-2xl font-bold text-gray-900">{{ dashboard_data.celery_metrics.queues.total_pending or 0 }}</p>
                    </div>
                    <div class="h-12 w-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-list text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Error Rate -->
            <div class="metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Failed Pages (24h)</p>
                        <p class="text-2xl font-bold text-gray-900">{{ dashboard_data.error_analysis.database_errors.total_failed_pages or 0 }}</p>
                    </div>
                    <div class="h-12 w-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Health Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Service Status -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-heartbeat text-red-500 mr-2"></i>
                    Service Health
                </h3>
                <div class="space-y-4">
                    {% for service_name, service_data in dashboard_data.system_health.services.items() %}
                    <div class="flex items-center justify-between p-3 border rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="status-indicator status-{{ service_data.status }} w-3 h-3 rounded-full"></div>
                            <div>
                                <p class="font-medium text-gray-900">{{ service_name|title }}</p>
                                {% if service_data.response_time_ms %}
                                <p class="text-sm text-gray-500">{{ service_data.response_time_ms }}ms response</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="status-badge status-{{ service_data.status }} px-2 py-1 rounded text-xs font-medium">
                                {{ service_data.status|title }}
                            </span>
                            {% if service_data.issues %}
                            <p class="text-xs text-red-600 mt-1">{{ service_data.issues|length }} issues</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- System Metrics -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-microchip text-blue-500 mr-2"></i>
                    System Resources
                </h3>
                <div class="space-y-4">
                    {% set system = dashboard_data.system_health.infrastructure.system %}
                    
                    <!-- CPU Usage -->
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-600">CPU Usage</span>
                        <div class="flex items-center space-x-2">
                            <div class="w-24 bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: {{ system.cpu.usage_percent }}%"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-900">{{ "%.1f"|format(system.cpu.usage_percent) }}%</span>
                        </div>
                    </div>

                    <!-- Memory Usage -->
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-600">Memory Usage</span>
                        <div class="flex items-center space-x-2">
                            <div class="w-24 bg-gray-200 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full" style="width: {{ system.memory.usage_percent }}%"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-900">{{ "%.1f"|format(system.memory.usage_percent) }}%</span>
                        </div>
                    </div>

                    <!-- Disk Usage -->
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-600">Disk Usage</span>
                        <div class="flex items-center space-x-2">
                            <div class="w-24 bg-gray-200 rounded-full h-2">
                                <div class="bg-yellow-600 h-2 rounded-full" style="width: {{ system.disk.usage_percent }}%"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-900">{{ "%.1f"|format(system.disk.usage_percent) }}%</span>
                        </div>
                    </div>

                    <!-- Load Average -->
                    {% if system.load %}
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-600">Load Average</span>
                        <span class="text-sm font-medium text-gray-900">
                            {{ system.load.load_1m }} / {{ system.load.load_5m }} / {{ system.load.load_15m }}
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Celery Workers and Queues -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Worker Status -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-users text-green-500 mr-2"></i>
                    Celery Workers
                </h3>
                {% if dashboard_data.celery_metrics.workers.count %}
                <div class="space-y-3">
                    {% for worker_name, worker_data in dashboard_data.celery_metrics.workers.items() %}
                    {% if worker_name not in ['count', 'active_tasks'] %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="font-medium text-gray-900">{{ worker_name }}</p>
                            <p class="text-sm text-gray-500">{{ worker_data.active_tasks }} active tasks</p>
                        </div>
                        {% if worker_data.total_tasks %}
                        <span class="text-sm text-gray-600">{{ worker_data.total_tasks }} total</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-3"></i>
                    <p class="text-gray-600">No active Celery workers found</p>
                </div>
                {% endif %}
            </div>

            <!-- Queue Status -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-list text-yellow-500 mr-2"></i>
                    Task Queues
                </h3>
                <div class="space-y-3">
                    {% for queue_name, queue_length in dashboard_data.celery_metrics.queues.items() %}
                    {% if queue_name != 'total_pending' and queue_name != 'error' %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="font-medium text-gray-900">{{ queue_name|title }}</p>
                            <p class="text-sm text-gray-500">Queue length</p>
                        </div>
                        <div class="text-right">
                            <span class="text-lg font-bold {% if queue_length > 50 %}text-red-600{% elif queue_length > 20 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                {{ queue_length }}
                            </span>
                            <p class="text-xs text-gray-500">tasks</p>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Error Analysis -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-bug text-red-500 mr-2"></i>
                Error Analysis (Last 24 Hours)
            </h3>
            
            {% if dashboard_data.error_analysis.database_errors.total_failed_pages > 0 %}
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Error Types -->
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">Error Types</h4>
                    <div class="space-y-2">
                        {% for error_type, count in dashboard_data.error_analysis.database_errors.error_types.items() %}
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <span class="text-sm text-gray-700">{{ error_type }}</span>
                            <span class="font-medium text-red-600">{{ count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Recent Failures -->
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">Recent Failures</h4>
                    <div class="space-y-2">
                        {% for failure in dashboard_data.error_analysis.database_errors.recent_failures[:5] %}
                        <div class="p-2 bg-gray-50 rounded">
                            <p class="text-sm font-medium text-gray-900 truncate">{{ failure.url }}</p>
                            <p class="text-xs text-gray-500">{{ failure.scraped_at }}</p>
                            {% if failure.error %}
                            <p class="text-xs text-red-600 truncate">{{ failure.error }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-8">
                <i class="fas fa-check-circle text-green-500 text-3xl mb-3"></i>
                <p class="text-gray-600">No errors detected in the last 24 hours</p>
            </div>
            {% endif %}
        </div>

        <!-- Application Metrics -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- User Activity -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-users text-blue-500 mr-2"></i>
                    User Activity (7 days)
                </h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">New Registrations</span>
                        <span class="font-medium text-gray-900">{{ dashboard_data.application_metrics.user_activity.new_registrations }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Active Users</span>
                        <span class="font-medium text-gray-900">{{ dashboard_data.application_metrics.user_activity.active_users }}</span>
                    </div>
                </div>
            </div>

            <!-- Scraping Performance -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-spider text-purple-500 mr-2"></i>
                    Scraping (7 days)
                </h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Sessions</span>
                        <span class="font-medium text-gray-900">{{ dashboard_data.application_metrics.scraping_performance.total_sessions }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Pages Scraped</span>
                        <span class="font-medium text-gray-900">{{ dashboard_data.application_metrics.scraping_performance.pages_scraped }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Avg Process Time</span>
                        <span class="font-medium text-gray-900">{{ "%.1f"|format(dashboard_data.application_metrics.scraping_performance.avg_processing_time_seconds) }}s</span>
                    </div>
                </div>
            </div>

            <!-- System Overview -->
            {% if dashboard_data.shared_pages_metrics.status != 'unavailable' %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-share-alt text-green-500 mr-2"></i>
                    Shared Pages
                </h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Total Pages</span>
                        <span class="font-medium text-gray-900">{{ dashboard_data.shared_pages_metrics.core_metrics.total_shared_pages }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Processed</span>
                        <span class="font-medium text-gray-900">{{ dashboard_data.shared_pages_metrics.core_metrics.processed_pages }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Dedup Rate</span>
                        <span class="font-medium text-gray-900">{{ dashboard_data.shared_pages_metrics.deduplication_metrics.deduplication_rate_percent }}%</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- JavaScript for real-time updates -->
    <script>
        const dashboardData = {{ dashboard_json|safe }};
        let autoRefresh = false;
        let refreshInterval;

        // Auto refresh toggle
        document.getElementById('auto-refresh-toggle').addEventListener('click', function() {
            autoRefresh = !autoRefresh;
            const btn = this;
            const icon = btn.querySelector('i');
            
            if (autoRefresh) {
                btn.textContent = '';
                btn.innerHTML = '<i class="fas fa-pause mr-2"></i> Auto Refresh';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
                
                // Start auto refresh every 30 seconds
                refreshInterval = setInterval(refreshData, 30000);
            } else {
                btn.textContent = '';
                btn.innerHTML = '<i class="fas fa-play mr-2"></i> Auto Refresh';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
            }
        });

        // Manual refresh
        document.getElementById('refresh-btn').addEventListener('click', refreshData);

        async function refreshData() {
            const refreshBtn = document.getElementById('refresh-btn');
            const icon = refreshBtn.querySelector('i');
            
            // Show loading state
            icon.classList.add('refresh-spinner');
            refreshBtn.disabled = true;
            
            try {
                // Fetch updated system status
                const response = await fetch('/admin/monitoring/api/system-status');
                const data = await response.json();
                
                // Update last updated time
                document.getElementById('last-updated').textContent = new Date(data.timestamp).toLocaleString();
                
                // Update overall status indicator
                const statusIndicator = document.querySelector('.status-indicator');
                statusIndicator.className = `status-indicator status-${data.overall_status} px-3 py-1 rounded-full text-sm font-medium border`;
                statusIndicator.innerHTML = `<i class="fas fa-circle pulse-dot mr-1"></i>${data.overall_status.charAt(0).toUpperCase() + data.overall_status.slice(1)}`;
                
                // Update individual service statuses (if elements exist)
                Object.entries(data.checks).forEach(([serviceName, serviceData]) => {
                    const serviceElement = document.querySelector(`[data-service="${serviceName}"]`);
                    if (serviceElement) {
                        const statusBadge = serviceElement.querySelector('.status-badge');
                        if (statusBadge) {
                            statusBadge.className = `status-badge status-${serviceData.status} px-2 py-1 rounded text-xs font-medium`;
                            statusBadge.textContent = serviceData.status.charAt(0).toUpperCase() + serviceData.status.slice(1);
                        }
                    }
                });
                
                console.log('Dashboard refreshed successfully');
                
            } catch (error) {
                console.error('Error refreshing dashboard:', error);
            } finally {
                // Remove loading state
                icon.classList.remove('refresh-spinner');
                refreshBtn.disabled = false;
            }
        }

        // Update timestamps periodically
        setInterval(function() {
            const timestampElements = document.querySelectorAll('[data-timestamp]');
            timestampElements.forEach(el => {
                const timestamp = el.getAttribute('data-timestamp');
                if (timestamp) {
                    el.textContent = new Date(timestamp).toLocaleString();
                }
            });
        }, 1000);

        // Initialize button styles
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                .btn {
                    @apply inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors;
                }
                .btn-primary {
                    @apply text-white bg-blue-600 hover:bg-blue-700 focus:ring-blue-500;
                }
                .btn-secondary {
                    @apply text-gray-700 bg-white hover:bg-gray-50 border-gray-300 focus:ring-blue-500;
                }
                .status-badge {
                    @apply inline-flex items-center;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>