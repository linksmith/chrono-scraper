version: '3.8'

services:
  svelte:
    container_name: 'svelte-service'
    build:
      context: ./svelte/
      dockerfile: Dockerfile.prod
    restart: always
    ports:
      - 8080:8080

  nginx:
    container_name: 'nginx-service'
    build:
      context: ./nginx/
      dockerfile: Dockerfile.prod
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./config:/config
      - /nginx/etc/letsencrypt:/etc/letsencrypt:ro
      - /nginx/tmp/acme_challenge:/tmp/acme_challenge
    restart: always

  redis:
    image: redis:latest
    restart: always

  fastapi:
    build: ./fastapi
    restart: always
    environment:
      - PORT=8000
      - DATABASE_URL=${DATABASE_URL}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    expose:
      - 8000
    depends_on:
      - redis
  # celery_worker:
  #   build: ./fastapi
  #   command: celery -A chrono-scraper.worker worker --loglevel=info
  #   volumes:
  #     - ./fastapi:/app
  #   depends_on:
  #     - redis
  #     - fastapi
  #   restart: always

  # strapi:
  #   container_name: strapi
  #   build: ./strapi
  #   image: strapi:latest
  #   restart: unless-stopped
  #   env_file: .env
  #   environment:
  #     DATABASE_CLIENT: ${DATABASE_CLIENT}
  #     DATABASE_HOST: postgresql
  #     DATABASE_PORT: ${DATABASE_PORT}
  #     DATABASE_NAME: ${DATABASE_NAME}
  #     DATABASE_USERNAME: ${DATABASE_USERNAME}
  #     DATABASE_PASSWORD: ${DATABASE_PASSWORD}
  #     JWT_SECRET: ${JWT_SECRET}
  #     ADMIN_JWT_SECRET: ${ADMIN_JWT_SECRET}
  #     APP_KEYS: ${APP_KEYS}
  #     NODE_ENV: ${NODE_ENV}
  #   volumes:
  #     - ./strapi/config:/opt/app/config
  #     - ./strapi/src:/opt/app/src
  #     - ./strapi/package.json:/opt/package.json
  #     - ./strapi/yarn.lock:/opt/yarn.lock
  #     - ./strapi/public/uploads:/opt/app/public/uploads
  #     - ./.env:/opt/app/.env
  #   ports:
  #     - "1337:1337"
